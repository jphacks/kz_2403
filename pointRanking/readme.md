# 概要

Slackに関するあらゆるデータ（メッセージデータ、絵文字データ、ユーザーデータなど）を保存し、各種スラッシュコマンドを実装。

## ポイントランキング

### 概要

ユーザーがプロジェクトのコミュニケーション活性化にコミットする動機として、リアクションを行うたびにポイントを付与する。その合計を定期実行で月初に表示したり、任意で現在のポイント状況を確認できるようにする。

### 流れ

1. **データ保存**
    - Slack APIがユーザーのリアクション（メッセージや絵文字）を受け取り、Slackbotがそれに応じてSupabaseに各種データを保存するイベントを送信。
        
        > 💡 エラーが起きないように、各種操作の前にテーブル内の依存関係に問題がないか確認を行う。
        > 
    - その後、以下の条件でポイントを`userNew`テーブルに保存。
        - 絵文字を押した順番が1番の人に3ポイント、2番目の人に2ポイント、3番目以降の人に1ポイントを付与
        - 送信後、5分以内に絵文字を押した人に1ポイントを付与
        - メンション（`@〇〇`）を使用した人に1ポイントを付与
        - 特定のキーワードを使用した人に1ポイントを付与
        
        > 💡 注意: メッセージ毎に付与するポイントは一度だけにしたいため、ensureHasUserReactedBeforeで確認して重複を防ぐ。
        > 
    - Supabaseを採用しているため、リアルタイムでデータが更新する。
2. **データ表示**
    - 以下の方法で、現在のポイント取得状況を確認。
        - `ranking`コマンドを入力
            - 全体ランキング
            - 月別ランキング
            - 個人ポイント
        - 月末実行
            - Cloudflare Workersで月別ランキングを月末に実行
    - これにより、任意のチャンネルでランキングを表示することができる。

## ランダム質問

### 概要

- **ランダム質問の送信**: 定期的にワークスペース内のアクティブなユーザーに対してランダムな質問をDMで送信。
- **回答の収集と表示**: ユーザーが回答すると、その回答を指定されたチャンネルに投稿。
- **スケジューリング**: 質問の送信は、指定された営業時間内（10:00〜20:00）の2〜4時間の間隔で行われる。

### 流れ

1. `randomQuestionScheduler.ts`が定期的に`sendRandomQuestion`を呼び出し、ユーザーに対して`question.json`からランダムな質問を送信。
2. ユーザーがDMで質問に回答すると、`modalHandler.ts`が回答を処理し、回答内容が指定されたチャンネルに送信される。回答後、ユーザーにはDMで感謝のメッセージが届く。

## 質問投稿機能

### 概要

`/question`コマンドを使用すると、質問モーダルが開き、ユーザーは任意のチャンネルに質問を投稿できる。投稿された質問は`@channel`で全ユーザーに通知され、他のユーザーは「回答する」ボタンを押すことで質問に返答できる。返答は指定されたチャンネルにスレッドとして投稿され、回答者のプロフィール画像も表示される。

### 流れ

1. ユーザーが`/question`コマンドを入力すると、ハンドラーがコマンドを受け取り質問モーダルを開く。
2. ユーザーが質問内容と必要に応じて画像を入力・アップロードし、投稿ボタンを押す。
3. `handleQuestionAnswerSubmission`ハンドラーがモーダルの送信イベントを受け取り、入力された質問と画像URLを取得し、指定されたチャンネルにメンション付きで投稿される。
4. 「回答する」ボタンを押すと、回答モーダルが開き、送信ボタンを押すことで質問と同様の流れで返信が投稿される。

### 現状の問題点

質問・回答データをサーバーのメモリに保持しているため、Supabaseにテーブルを追加してデータを永続化しない場合、サーバーの再起動で機能が停止される。

## 投票機能

### 概要

アンケートやミーティングの調整を行いたい際に使用できる機能。投票を希望するユーザーが質問内容、選択肢、および制限時間を設定することで、任意のチャンネルに投票メッセージが表示される。他のユーザーはボタンを押して投票に参加でき、制限時間が終了すると自動的に結果が集計・表示される。リアルタイムで現在の投票状況も確認可能。

### 流れ

1. ユーザーが`/vote`コマンドを入力すると、ハンドラーがコマンドを受け取り投票設定モーダルを開く。
2. モーダルには投票の質問、選択肢、画像をアップロードするフィールド、終了日時を選択するフィールドが含まれており、入力後に送信ボタンを押す。
3. `handleVoteModalSubmission`関数がモーダルの送信イベントを処理し、投票メッセージのブロックを作成後、任意のチャンネルに投票の質問が投稿される。また、投票終了時刻に合わせてタイマーがセットされる。
4. ユーザーが投票すると、`handleVote`関数が呼び出され、投票データが更新される。投票が更新されると、メッセージがリアルタイムで更新され、現在の投票結果が反映される。
5. 指定された時間になると、タイマーが終了し、最終結果が表示される。

## 文字装飾機能

### 概要

主張を強調したいときにおすすめの機能。複数の種類の装飾を施した大きめの文字を任意のチャンネル上に送信できる。ユーザーは異なるスタイルを選択して、テキストを視覚的に強調することが可能。

### 流れ

1. ユーザーがSlackで`/decorate`コマンドを入力する。
2. `decorateCommand.ts`のハンドラーがこのコマンドを受け取り、装飾設定モーダルを開く。
3. モーダルには装飾するテキストを入力するフィールドと、装飾スタイルを選択するセクションが含まれており、テキストを入力し、スタイルを選択される。
4. `handleDecorateModalSubmission`関数によって送信イベントが処理され、装飾されたテキストが任意のチャンネルに生成される。
